<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Gestion d'Abonnements</title>
  <link rel="stylesheet" href="/academic.css">
</head>
<body>

<!-- Navigation -->
<nav class="navbar">
  <div class="container">
    <a class="navbar-brand" href="/index.html">
      üìã Dashboard Abonnements
    </a>
    <div style="display: inline-block; margin-left: auto;">
      <a href="/index.html">Dashboard</a>
      <a href="/subscriptions.html">Abonnements</a>
      <a href="/stats.html">Statistiques</a>
    </div>
  </div>
</nav>

<!-- Contenu principal -->
<main class="container">
  <h1 style="margin-bottom: 2rem;">Dashboard - Vue d'ensemble</h1>

  <!-- KPIs -->
  <section class="section">
    <h2 class="section-title">M√©triques principales</h2>
    <div id="kpi-container" class="kpi-grid">
      <!-- Cartes KPI inject√©es par JavaScript -->
    </div>
  </section>

  <!-- Abonnements √† risque -->
  <section class="section">
    <h2 class="section-title">‚ö†Ô∏è Abonnements √† risque</h2>
    <div id="risk-list">
      <!-- Liste des abonnements √† risque -->
    </div>
  </section>

  <!-- Dernier abonnement cr√©√© -->
  <section class="section">
    <h2 class="section-title">Informations du syst√®me</h2>
    <p id="system-info">Chargement...</p>
  </section>
</main>

<!-- Scripts -->
<script src="/api.js"></script>
<script src="/ui.js"></script>
<script>
/**
 * PAGE: Dashboard principal
 * Affiche les KPIs et les abonnements √† risque du backend
 */

async function loadDashboard() {
  const kpiContainer = document.getElementById('kpi-container');
  if (kpiContainer) {
    kpiContainer.innerHTML = '<p class="text-muted">Chargement des m√©triques...</p>';
  }
  const riskContainer = document.getElementById('risk-list');
  if (riskContainer) {
    riskContainer.innerHTML = '<p class="text-muted">Analyse des risques...</p>';
  }
  const systemInfo = document.getElementById('system-info');
  if (systemInfo) {
    systemInfo.textContent = 'Chargement...';
  }

  try {
    const abonnements = await fetchAbonnements();

    const now = new Date();
    const total = abonnements.length;
    const active = abonnements.filter(ab => {
      if (!ab.dateDebut || !ab.dateFin) return false;
      const start = new Date(ab.dateDebut);
      const end = new Date(ab.dateFin);
      return start <= now && end >= now;
    }).length;
    const monthlyCost = abonnements.reduce((sum, ab) => sum + (Number(ab.prixMensuel) || 0), 0);
    const highRisk = abonnements.filter(ab => (Number(ab.churnRisk) || 0) > 70);
    const healthScore = total === 0 ? 0 : Math.round((active / total) * 100);

    renderDashboardKPIs({
      totalAbonnements: total,
      coutMensuel: monthlyCost,
      scoreSante: healthScore,
      abonnementsAuRisque: highRisk.length
    });

    renderRiskList(highRisk);

    const info = [
      `Total: ${total}`,
      `Actifs: ${active}`,
      `D√©pense mensuelle: ${formatCurrency(monthlyCost)}`,
      `Sant√© estim√©e: ${healthScore}%`,
      `√Ä risque: ${highRisk.length}`
    ].join(' | ');
    if (systemInfo) {
      systemInfo.textContent = info;
    }
  } catch (error) {
    console.error('Erreur lors du chargement du dashboard:', error);
    showError(`Erreur de chargement du dashboard: ${error.message}`);
    renderDashboardKPIs({
      totalAbonnements: 0,
      coutMensuel: 0,
      scoreSante: 0,
      abonnementsAuRisque: 0
    });
    renderRiskList([]);
    if (systemInfo) {
      systemInfo.textContent = 'Impossible de charger les donn√©es du dashboard.';
    }
  }
}

// Charger au d√©marrage
window.addEventListener('DOMContentLoaded', loadDashboard);

// Rafra√Æchir toutes les 5 minutes
setInterval(loadDashboard, 5 * 60 * 1000);
</script>

</body>
</html>
