<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statistiques - Gestion d'Abonnements</title>
  <link rel="stylesheet" href="/academic.css">
</head>
<body>

<!-- Navigation -->
<nav class="navbar">
  <div class="container">
    <a class="navbar-brand" href="/index.html">
      üìã Dashboard Abonnements
    </a>
    <div style="display: inline-block; margin-left: auto;">
      <a href="/index.html">Dashboard</a>
      <a href="/subscriptions.html">Abonnements</a>
      <a href="/stats.html">Statistiques</a>
    </div>
  </div>
</nav>

<!-- Contenu principal -->
<main class="container">
  <h1 style="margin-bottom: 2rem;">Statistiques du portefeuille</h1>

  <!-- Statistiques principales -->
  <section class="section">
    <h2 class="section-title">Vue d'ensemble financi√®re</h2>
    <div id="stats-container" class="grid-2">
      <!-- Cartes stats inject√©es par JavaScript -->
    </div>
  </section>

  <!-- D√©tails par cat√©gorie -->
  <section class="section">
    <h2 class="section-title">R√©partition par cat√©gorie</h2>
    <div id="category-stats">
      <!-- Tableau inject√© par JavaScript -->
    </div>
  </section>

  <!-- D√©tails par p√©riode -->
  <section class="section">
    <h2 class="section-title">√âvolution des co√ªts</h2>
    <div id="period-stats">
      <!-- Tableau inject√© par JavaScript -->
    </div>
  </section>

  <!-- Recommandations -->
  <section class="section">
    <h2 class="section-title">Recommandations d'optimisation</h2>
    <div id="recommendations">
      <!-- Recommandations inject√©es par JavaScript -->
    </div>
  </section>
</main>

<!-- Scripts -->
<script src="/api.js"></script>
<script src="/ui.js"></script>
<script>
/**
 * PAGE: Statistiques
 */

/**
 * Charge et affiche les statistiques
 */
async function loadStatsPage() {
  const statsContainer = document.getElementById('stats-container');
  if (statsContainer) {
    statsContainer.innerHTML = '<p class="text-muted">Chargement des statistiques...</p>';
  }
  const categoryContainer = document.getElementById('category-stats');
  if (categoryContainer) {
    categoryContainer.innerHTML = '<p class="text-muted">Analyse des cat√©gories...</p>';
  }
  const recommendationsContainer = document.getElementById('recommendations');
  if (recommendationsContainer) {
    recommendationsContainer.innerHTML = '<p class="text-muted">Calcul des recommandations...</p>';
  }

  try {
    const abonnements = await fetchAbonnements();
    const monthlyCost = abonnements.reduce((sum, ab) => sum + (Number(ab.prixMensuel) || 0), 0);
    const activeCount = abonnements.filter(isActiveSubscription).length;
    const stats = {
      totalAnnuel: monthlyCost * 12,
      abonnementsActifs: activeCount,
      moyenneMensuelle: abonnements.length === 0 ? 0 : monthlyCost / abonnements.length,
      economiePotentielle: calculateSavings(abonnements)
    };
    renderStats(stats);

    // Afficher les stats par cat√©gorie
    renderCategoryStats(abonnements);

    // Afficher les recommandations
    renderStatsRecommendations(abonnements, stats);
  } catch (error) {
    console.error('Erreur:', error);
    showError(`Erreur lors du chargement des statistiques: ${error.message}`);
    if (statsContainer) {
      statsContainer.innerHTML = '<p class="text-muted">Aucune donn√©e disponible.</p>';
    }
    if (categoryContainer) {
      categoryContainer.innerHTML = '';
    }
    if (recommendationsContainer) {
      recommendationsContainer.innerHTML = '<p class="text-muted">Aucune recommandation g√©n√©r√©e.</p>';
    }
  }
}

function isActiveSubscription(abonnement) {
  if (!abonnement || !abonnement.dateDebut || !abonnement.dateFin) return false;
  const now = new Date();
  const start = new Date(abonnement.dateDebut);
  const end = new Date(abonnement.dateFin);
  return start <= now && end >= now;
}

/**
 * Calcule les √©conomies potentielles
 */
function calculateSavings(abonnements) {
  if (!abonnements || abonnements.length === 0) return 0;
  const total = abonnements.reduce((sum, ab) => sum + (Number(ab.prixMensuel) || 0), 0);
  return total * 0.1;
}

/**
 * Affiche les stats par cat√©gorie
 */
function renderCategoryStats(abonnements) {
  const container = document.getElementById('category-stats');
  if (!container) return;
  
  const categories = {};
  abonnements.forEach(ab => {
    const cat = ab.categorie || 'Sans cat√©gorie';
    if (!categories[cat]) {
      categories[cat] = { count: 0, total: 0 };
    }
    categories[cat].count++;
    categories[cat].total += Number(ab.prixMensuel) || 0;
  });

  let html = '<table class="table"><thead><tr><th>Cat√©gorie</th><th>Nombre</th><th>Co√ªt mensuel</th></tr></thead><tbody>';
  Object.entries(categories).forEach(([cat, data]) => {
    html += `<tr><td>${cat}</td><td>${data.count}</td><td>${formatCurrency(data.total)}</td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

/**
 * Affiche les recommandations d'optimisation
 */
function renderStatsRecommendations(abonnements, stats) {
  const container = document.getElementById('recommendations');
  if (!container) return;
  
  const recommendations = [];

  const expired = abonnements.filter(ab => {
    if (!ab.dateFin) return false;
    return new Date(ab.dateFin) < new Date();
  });
  
  if (expired.length > 0) {
    recommendations.push(`<div class="alert alert-warning">‚≠ê <strong>${expired.length} abonnement(s) expir√©(s)</strong></div>`);
  }

  const expensive = [...abonnements]
    .sort((a, b) => (Number(b.prixMensuel) || 0) - (Number(a.prixMensuel) || 0))
    .slice(0, 3);
  if (expensive.length > 0) {
    const expStr = expensive.map(ab => ab.nomService || 'Service').join(', ');
    recommendations.push(`<div class="alert alert-info">üí∞ <strong>√Ä v√©rifier:</strong> ${expStr}</div>`);
  }

  if (stats.economiePotentielle > 0) {
    recommendations.push(`<div class="alert alert-success">‚úÖ <strong>√âconomies:</strong> ${formatCurrency(stats.economiePotentielle)}/mois</div>`);
  }

  if (recommendations.length === 0) {
    recommendations.push('<p>Aucune recommandation</p>');
  }

  container.innerHTML = recommendations.join('');
}

window.addEventListener('DOMContentLoaded', loadStatsPage);
</script>

</body>
</html>
