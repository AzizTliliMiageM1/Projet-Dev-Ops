<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Abonnements - Gestion</title>
  <link rel="stylesheet" href="/academic.css">
</head>
<body>

<!-- Navigation -->
<nav class="navbar">
  <div class="container">
    <a class="navbar-brand" href="/index.html">
      üìã Dashboard Abonnements
    </a>
    <div style="display: inline-block; margin-left: auto;">
      <a href="/index.html">Dashboard</a>
      <a href="/subscriptions.html">Abonnements</a>
      <a href="/stats.html">Statistiques</a>
    </div>
  </div>
</nav>

<!-- Contenu principal -->
<main class="container">
  <h1 style="margin-bottom: 2rem;">Gestion des abonnements</h1>

  <!-- Formulaire cr√©ation/modification -->
  <section class="section">
    <h2 class="section-title">Cr√©er/Modifier un abonnement</h2>
    <div id="subscription-form">
      <!-- Formulaire inject√© par JavaScript -->
    </div>
  </section>

  <!-- Liste des abonnements -->
  <section class="section">
    <h2 class="section-title">Liste des abonnements</h2>
    <div style="margin-bottom: 1rem;">
      <input 
        type="text" 
        id="search-input" 
        class="form-control" 
        placeholder="Rechercher par client ou service..."
        style="max-width: 400px;">
    </div>
    <div id="subscriptions-table">
      <!-- Tableau inject√© par JavaScript -->
    </div>
  </section>
</main>

<!-- Scripts -->
<script src="/api.js"></script>
<script src="/ui.js"></script>
<script>
/**
 * PAGE: Gestion CRUD des abonnements
 */

let allAbonnements = [];

/**
 * Charge la page et affiche tous les abonnements
 */
async function loadSubscriptionsPage() {
  const formContainer = document.getElementById('subscription-form');
  const tableContainer = document.getElementById('subscriptions-table');

  if (formContainer && formContainer.childElementCount === 0) {
    formContainer.innerHTML = '<p class="text-muted">Pr√©paration du formulaire...</p>';
  }
  if (tableContainer) {
    tableContainer.innerHTML = '<p class="text-muted">Chargement des abonnements...</p>';
  }

  try {
    allAbonnements = await fetchAbonnements();
    
    // Afficher le formulaire de cr√©ation
    renderSubscriptionForm(null);
    
    // Afficher la liste
    renderSubscriptionsTable(allAbonnements);
  } catch (error) {
    console.error('Erreur:', error);
    showError(`Erreur lors du chargement des abonnements: ${error.message}`);
    allAbonnements = [];
    if (tableContainer) {
      tableContainer.innerHTML = '<p class="text-muted">Impossible de r√©cup√©rer les abonnements.</p>';
    }
    renderSubscriptionForm(null);
  }
}

/**
 * √âditer un abonnement
 */
async function editSubscriptionId(id) {
  const ab = allAbonnements.find(a => a.id === id);
  if (ab) {
    renderSubscriptionForm(ab);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

/**
 * Supprimer un abonnement
 */
async function deleteSubscriptionId(id) {
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet abonnement?')) {
    return;
  }
  try {
    await deleteAbonnement(id);
    showSuccess('‚úÖ Abonnement supprim√©');
    await loadSubscriptionsPage();
  } catch (error) {
    console.error('Erreur suppression abonnement:', error);
    showError(`‚ùå Erreur lors de la suppression: ${error.message}`);
  }
}

/**
 * Recherche/Filtre en temps r√©el
 */
document.addEventListener('DOMContentLoaded', () => {
  loadSubscriptionsPage();
  
  const searchInput = document.getElementById('search-input');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const filtered = allAbonnements.filter(ab =>
        (ab.clientName && ab.clientName.toLowerCase().includes(query)) ||
        (ab.nomService && ab.nomService.toLowerCase().includes(query)) ||
        (ab.categorie && ab.categorie.toLowerCase().includes(query))
      );
      renderSubscriptionsTable(filtered);
    });
  }
});
</script>

</body>
</html>
