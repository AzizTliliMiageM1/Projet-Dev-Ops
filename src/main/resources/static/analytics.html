<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - GestionPro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="home.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analytics-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .metric-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 1.5rem;
            color: white;
            text-align: center;
            margin-bottom: 1rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .risk-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin: 0.25rem;
        }

        .risk-high { background: #dc3545; color: white; }
        .risk-medium { background: #ffc107; color: #333; }
        .risk-low { background: #28a745; color: white; }

        .recommendation-card {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #667eea;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: white;
        }

        .subscription-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .score-excellent { background: #28a745; color: white; }
        .score-good { background: #17a2b8; color: white; }
        .score-warning { background: #ffc107; color: #333; }
        .score-danger { background: #dc3545; color: white; }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .page-header {
            text-align: center;
            padding: 3rem 0 2rem;
        }

        .duplicate-warning {
            background: rgba(255, 193, 7, 0.2);
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
        }

        .forecast-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 0.5rem;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: rgba(0,0,0,0.3); backdrop-filter: blur(10px);">
        <div class="container">
            <a class="navbar-brand fw-bold" href="home.html">
                <i class="fas fa-chart-line"></i> GestionPro
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="home.html">Accueil</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active" href="analytics.html">Analytics</a></li>
                    <li class="nav-item"><a class="nav-link" href="api.html">API</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container" style="max-width: 1400px;">
        <!-- Header -->
        <div class="page-header">
            <h1 class="display-4 fw-bold"><i class="fas fa-chart-bar"></i> Analytics Avanc√©s</h1>
            <p class="lead">Intelligence artificielle pour optimiser vos abonnements</p>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-3">Analyse en cours...</p>
        </div>

        <!-- Content (hidden until loaded) -->
        <div id="content" style="display: none;">
            
            <!-- M√©triques Principales -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="metric-box">
                        <i class="fas fa-star fa-2x"></i>
                        <div class="metric-value" id="optimizationScore">--</div>
                        <div class="metric-label">Score d'Optimisation</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-piggy-bank fa-2x"></i>
                        <div class="metric-value" id="potentialSavings">--</div>
                        <div class="metric-label">√âconomies Potentielles</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-trophy fa-2x"></i>
                        <div class="metric-value" id="averageROI">--</div>
                        <div class="metric-label">ROI Moyen</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <div class="metric-value" id="highRiskCount">--</div>
                        <div class="metric-label">Abonnements √† Risque</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Rapport d'Optimisation -->
                <div class="col-lg-8">
                    <div class="analytics-card">
                        <h3><i class="fas fa-chart-line"></i> Analyse D√©taill√©e</h3>
                        <div id="subscriptionAnalysis"></div>
                    </div>

                    <!-- Pr√©vision Tr√©sorerie -->
                    <div class="analytics-card">
                        <h3><i class="fas fa-chart-area"></i> Pr√©vision Tr√©sorerie (6 mois)</h3>
                        <div class="chart-container">
                            <canvas id="forecastChart"></canvas>
                        </div>
                    </div>

                    <!-- Anomalies -->
                    <div class="analytics-card">
                        <h3><i class="fas fa-exclamation-circle"></i> Anomalies D√©tect√©es</h3>
                        <div id="anomaliesList"></div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Recommandations -->
                    <div class="analytics-card">
                        <h4><i class="fas fa-lightbulb"></i> Recommandations</h4>
                        <div id="recommendations"></div>
                    </div>

                    <!-- Services Redondants -->
                    <div class="analytics-card">
                        <h4><i class="fas fa-copy"></i> Services en Doublon</h4>
                        <div id="duplicates"></div>
                    </div>

                    <!-- Top 3 D√©penses -->
                    <div class="analytics-card">
                        <h4><i class="fas fa-fire"></i> Top 3 D√©penses</h4>
                        <div id="topExpenses"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let forecastChart = null;

        // Charger toutes les analytics
        async function loadAnalytics() {
            try {
                // Charger donn√©es en parall√®le
                const [optimize, forecast, metrics, anomalies, duplicates, monthlyReport] = await Promise.all([
                    fetch('/api/analytics/optimize').then(r => r.json()),
                    fetch('/api/analytics/forecast').then(r => r.json()),
                    fetch('/api/analytics/metrics').then(r => r.json()),
                    fetch('/api/analytics/anomalies').then(r => r.json()),
                    fetch('/api/analytics/duplicates').then(r => r.json()),
                    fetch('/api/analytics/monthly-report').then(r => r.json())
                ]);

                // Afficher m√©triques principales
                displayMainMetrics(optimize, metrics);

                // Afficher analyse d√©taill√©e
                displaySubscriptionAnalysis(optimize.analyses);

                // Afficher pr√©visions
                displayForecast(forecast);

                // Afficher anomalies
                displayAnomalies(anomalies);

                // Afficher doublons
                displayDuplicates(duplicates);

                // Afficher recommandations
                displayRecommendations(monthlyReport.recommendations);

                // Afficher top d√©penses
                displayTopExpenses(monthlyReport.top3Depenses);

                // Masquer loading, afficher contenu
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (error) {
                console.error('Erreur chargement analytics:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Erreur: ${error.message || 'Vous devez √™tre connect√©'}
                        <br><a href="login.html" class="btn btn-light mt-3">Se connecter</a>
                    </div>
                `;
            }
        }

        function displayMainMetrics(optimize, metrics) {
            // Score d'optimisation (calculer ici ou recevoir du backend)
            const score = 75; // √Ä calculer selon la logique
            document.getElementById('optimizationScore').textContent = score + '%';

            document.getElementById('potentialSavings').textContent = 
                optimize.economiesPotentielles.toFixed(2) + '‚Ç¨/mois';

            document.getElementById('averageROI').textContent = 
                metrics.averageROI.toFixed(0) + '%';

            document.getElementById('highRiskCount').textContent = 
                metrics.highRiskCount;
        }

        function displaySubscriptionAnalysis(analyses) {
            const container = document.getElementById('subscriptionAnalysis');
            
            if (!analyses || analyses.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucun abonnement actif</p>';
                return;
            }

            let html = '';
            analyses.forEach(analysis => {
                const abo = analysis.abonnement;
                const scoreClass = getScoreClass(analysis.valueScore);
                const riskBadge = getRiskBadge(analysis.churnRisk);

                html += `
                    <div class="subscription-item">
                        <div>
                            <h5 class="mb-1">${abo.nomService}</h5>
                            <small class="text-muted">${abo.categorie || 'Non class√©'}</small>
                            <div class="mt-2">
                                ${riskBadge}
                                ${analysis.priceAnomaly ? '<span class="risk-badge risk-high">‚ö†Ô∏è Prix anormal</span>' : ''}
                            </div>
                            <div class="mt-2 small">
                                <i class="fas fa-info-circle"></i> ${analysis.recommendation}
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="score-circle ${scoreClass}">
                                ${analysis.valueScore.toFixed(1)}
                            </div>
                            <small class="d-block mt-2">${abo.prixMensuel}‚Ç¨/mois</small>
                            <small class="text-muted">${analysis.costPerUse.toFixed(2)}‚Ç¨/usage</small>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displayForecast(forecast) {
            const labels = Object.keys(forecast);
            const data = Object.values(forecast);

            const ctx = document.getElementById('forecastChart').getContext('2d');
            
            if (forecastChart) forecastChart.destroy();

            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'D√©penses Pr√©vues (‚Ç¨)',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => context.parsed.y.toFixed(2) + '‚Ç¨'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => value + '‚Ç¨'
                            }
                        }
                    }
                }
            });
        }

        function displayAnomalies(anomalies) {
            const container = document.getElementById('anomaliesList');
            
            if (!anomalies || anomalies.length === 0) {
                container.innerHTML = '<p class="text-success"><i class="fas fa-check-circle"></i> Aucune anomalie d√©tect√©e</p>';
                return;
            }

            let html = '';
            anomalies.forEach(anomaly => {
                html += `
                    <div class="recommendation-card" style="border-left-color: #dc3545;">
                        <h6><i class="fas fa-exclamation-triangle"></i> ${anomaly.nomService}</h6>
                        <p class="mb-0">${anomaly.message} - <strong>${anomaly.prix}‚Ç¨/mois</strong></p>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displayDuplicates(duplicates) {
            const container = document.getElementById('duplicates');
            
            if (!duplicates || duplicates.length === 0) {
                container.innerHTML = '<p class="text-success"><i class="fas fa-check-circle"></i> Aucun doublon d√©tect√©</p>';
                return;
            }

            let html = '';
            duplicates.forEach(warning => {
                html += `<div class="duplicate-warning">${warning}</div>`;
            });

            container.innerHTML = html;
        }

        function displayRecommendations(recommendations) {
            const container = document.getElementById('recommendations');
            
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucune recommandation</p>';
                return;
            }

            let html = '';
            recommendations.forEach(rec => {
                html += `<div class="recommendation-card">${rec}</div>`;
            });

            container.innerHTML = html;
        }

        function displayTopExpenses(topExpenses) {
            const container = document.getElementById('topExpenses');
            
            if (!topExpenses || topExpenses.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucune donn√©e</p>';
                return;
            }

            let html = '';
            topExpenses.forEach((abo, index) => {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                html += `
                    <div class="forecast-item">
                        <span>${medals[index]} ${abo.nomService}</span>
                        <strong>${abo.prixMensuel}‚Ç¨</strong>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getScoreClass(score) {
            if (score >= 5) return 'score-excellent';
            if (score >= 3) return 'score-good';
            if (score >= 2) return 'score-warning';
            return 'score-danger';
        }

        function getRiskBadge(risk) {
            if (risk > 70) return '<span class="risk-badge risk-high">üö® Risque √©lev√©</span>';
            if (risk > 50) return '<span class="risk-badge risk-medium">‚ö†Ô∏è √Ä surveiller</span>';
            return '<span class="risk-badge risk-low">‚úÖ OK</span>';
        }

        // Charger au d√©marrage
        loadAnalytics();
    </script>
</body>
</html>
